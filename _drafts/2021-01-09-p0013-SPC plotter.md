---
title: "SPC 統計製程管制"
header:
  teaser: /assets/images/p0013/spc_demo_1.png
categories:
  - 碼農筆記
tags:
  - SPC
  - python
  - pandas
  - numpy
toc_label: "Outline"
---

# Statistic Process Control (SPC)
因為工作是個製程仔，所以每天最常看到的就是這個叫SPC的東西...  
SPC中文叫統計製程管制，當然叫SPC比較簡潔乾脆，主要用途是將要監控的參數標準化後，依照時間順序呈現在圖表上，當參數發生異常變動時，可由SPC chart觀察出來，  
當工程師發現管制圖異常，就要趕緊介入查看參數的異常原因。(不小心就說出我的工作日常QQ)  

## 管制圖?怎麼管?
SPC的歷史就不贅述了，餵狗第一條就有了~想說的是如果你要監控某個會隨著時間會增加資料的參數表現，就可以用SPC來查看這項參數的浮動情況。就好比下面這張圖:  

![](/assets/images/p0013/spc_demo_1.png)
{: .full}

譬如今天我們要生產一支iphone，供應商需要製造它螢幕上的玻璃，那麼在生產的過程中，為了確保玻璃面板的厚度、長度或寬度的參數不會異常，都會對這些參數訂一個目標值(Target)，想盡辦法將生產出來的貨品，其量測到的參數越接近target越好。將這些在生產中量測到的這些貨品參數對target值標準化後，以時間軸繪製出來，就能得到上圖。

而這張圖畫出來，就可以發現他之所以能「管」，便是建立在**中央極限定理**上。一道穩定的製程，在製造手續、製造機器都受到穩定控制的情況下，產品的參數便如同隨機變數，在經過收集多筆資料後，應當符合**常態分布**，上面講到的Target就是此道生產流程的目標值，理應同為數據的平均值。而SPC chart則是將這多筆的資料以時間這個維度做展開。如果我們將上圖的資料繪成組體圖表示的話，你會看到:  

![](/assets/images/p0013/spc_histogram_1.png)  

既然是數據組會呈現常態分佈，那麼必然會有機率出現資料點在平均值的三倍標準差之外，就像圖一的那些紅點所標示的。也因此，通常我們會以此製程的3倍標準差，當作管制圖的**管制標準(spec)**。當生產中量測到的參數超出spec，就會說這批貨的此項參數OOS(Out-Of-Spec)，而將此批貨的生產視為**存在異常**。  

先別一次說太多SPC的東西，太無聊了(工作日常誰想知道XD)  
來聊聊上面這些圖怎麼畫吧~  
首先準備資料的部分，我們根據SPC的理論，需要先產生一組以常態分配產生的亂數:

```python
import pandas as pd
import numpy as np
import os, sys, time, random
from datetime import datetime

def spc_gen(start_date, end_date, cnt=300, spec=3, target=28):
    start_datetime = datetime.strptime(start_date, '%Y/%m/%d %H:%M:%S.%f')
    end_datetime = datetime.strptime(end_date, '%Y/%m/%d %H:%M:%S.%f')

    start_date_num = int(start_datetime.timestamp())
    end_date_num = int(end_datetime.timestamp())

    time_series_num = np.random.randint(start_date_num, end_date_num, cnt)
    time_series = [datetime.fromtimestamp(x) for x in time_series_num]

    point_value = np.random.randn(cnt)*0.1

    SPEC = spec
    USL = np.ones(cnt)*SPEC
    LSL = np.ones(cnt)*-SPEC
    TARGET = np.ones(cnt)*target

    LETTER = ['U', 'X', 'T', 'G']
    lot6 = ['L7{0:s}{1:03d}'.format(LETTER[random.randint(0, 3)], random.randint(1, 999)) for x in range(cnt)]
    lot2 = ['{0:02d}'.format(random.randint(1, 99)) for x in range(cnt)]
    itemid = ['{0:02d}'.format(random.randint(1, 25)) for x in range(cnt)]
    lot_info = pd.DataFrame({
        'Lot6': lot6, 'Lot2': lot2, 'Item2': itemid
    }, columns=['Lot6', 'Lot2', 'Item2'])
    lot_info["Lot_ID"] = lot_info['Lot6'].str.cat(lot_info['Lot2'].values, sep='.')
    lot_info["Item_ID"] = lot_info['Lot6'].str.cat(lot_info['Item2'].values, sep='.')

    return pd.DataFrame({
        'Data_Time': time_series,
        'Lot_ID': lot_info['Lot_ID'].values,
        'Item_ID': lot_info['Item_ID'].values,
        'Point_Values': point_value,
        'Target': TARGET,
        'USL': USL,
        'LSL': LSL,
    }, columns=['Data_Time', 'Lot_ID', 'Item_ID', 'Point_Values', 'Target', 'USL', 'LSL'])

spc_df = spc_gen('2020/11/17 00:00:00.0', '2020/12/18 00:00:00.0', cnt=data_cnt, ctype=chart_type, spec=3*0.1)

```
```
	Data_Time	          Lot_ID	  Item_ID	  Point_Values	Target	USL	LSL
0	2020-11-30 12:39:32	L7X049.78	L7X049.15	1.143793	28.0	0.3	-0.3
1	2020-11-26 08:37:12	L7T589.10	L7T589.19	-0.879415	28.0	0.3	-0.3
2	2020-11-17 16:51:29	L7U078.16	L7U078.20	-0.476642	28.0	0.3	-0.3
3	2020-12-17 22:54:23	L7T028.54	L7T028.13	0.832083	28.0	0.3	-0.3
4	2020-12-14 14:14:09	L7G327.11	L7G327.17	0.756069	28.0	0.3	-0.3
```